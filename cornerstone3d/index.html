<html>
<head>
    <script type="text/javascript" src="cornerstone3d.js"></script>
    <script type="text/javascript" src="https://unpkg.com/cornerstone-wado-image-loader"></script>
    <script src="https://unpkg.com/dicom-parser"></script>
    <!--<script src="https://unpkg.com/cornerstone-math"></script>-->
    <script src="https://unpkg.com/cornerstone-tools"></script>
    <!--<script src="https://unpkg.com/hammerjs"></script>-->
    <script>

        let viewport;
        let imageIds;

        window.onload = function () {
            document.body.addEventListener('dragover', onDragOver);
            document.body.addEventListener('drop', onDrop);
        }

        function onDragOver(e) {

            // stop browser processing right away
            e.stopPropagation();
            e.preventDefault();

        };

        function onDrop(e) {

            e.stopPropagation();
            e.preventDefault();


            imageIds = [];

            for (let i = 0; i < e.dataTransfer.files.length; i++) {

                let f = e.dataTransfer.files[i];
                imageIds.push(cornerstoneWADOImageLoader.wadouri.fileManager.add(f));
            }

            console.log("imageIds: ");
            console.log(imageIds);


            const content = document.getElementById('content');
            const element = document.createElement('div');
            element.style.width = '500px';
            element.style.height = '500px';

            Node.content.appendChild(element);

            const renderingEngineId = 'myRenderingEngine';
            const viewportId = 'CT_AXIAL_STACK';
            const renderingEngine = new RenderingEngine(renderingEngineId);

            const viewportInput = {
                viewportId,
                element,
                type: ViewportType.STACK,
            };

            renderingEngine.enableElement(viewportInput);

            const viewport = renderingEngine.getViewport(viewportInput.viewportId);

            viewport.setStack(imageIds, 60);

            viewport.render();

            /*OUR CODE IS UNDER HERE!!! */
            //const renderingEngineId = 'r';
            //const renderingEngine = new cornerstone3dCore.RenderingEngine(renderingEngineId);

            //const viewportId = 'viewer';

            //var element = document.getElementById('viewer');

            //const viewportInput = {
            //    viewportId,
            //    type: cornerstone3dCore.Enums.ViewportType.STACK,
            //    element
            //};

            

            //renderingEngine.enableElement(viewportInput);
            //loadAndViewImage(imageIds);
            //viewport = renderingEngine.getViewport(viewportId);


            //       load_volume();

        }

        async function run() {
            await cornerstone3dCore.init();
            // DOESN'T WORK YET LOL
            //const toolGroup = cornerstone3dCore.tools.store.ToolGroupManager.createToolGroup('myToolGroup');
            //toolGroup.addViewport(viewportId, renderingEngineId);

        }

        async function load_volume() {


            // TODO
            volume = await cornerstone3dCore.volumeLoader.createAndCacheVolume(volumeId, {
                imageIds,
            });

            volume.load();

        }
        function loadAndViewImage(imageId) {
            const stack = [imageIds];
            // Set the stack on the viewport
            cornerstone3dCore.getRenderingEngine("r")._viewports.setStack(stack).then(() => {
                // Set the VOI of the stack
                // viewport.setProperties({ voiRange: ctVoiRange });
                // Render the image
                viewer.render();

//                const imageData = viewport.getImageData();
            });
        }

        run();



    </script>
</head>
<body style='margin:0px;padding:0px;background:black'>
    <div id="viewer" style="width: 100%; height:100%"></div>
</body>
</html>