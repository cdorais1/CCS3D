<html>
<head>
    <script type="text/javascript" src="cornerstone3d.js"></script>
    <script type="text/javascript" src="https://unpkg.com/cornerstone-wado-image-loader"></script>
    <script type="text/javascript" src="https://unpkg.com/dicom-parser"></script>
    <script src="https://unpkg.com/cornerstone-math"></script>
    <script src="https://unpkg.com/cornerstone-tools"></script>
    <script src="https://unpkg.com/hammerjs"></script>
    <script>

        cornerstoneWADOImageLoader.external.cornerstone = cornerstone3dCore;

        window.onload = function () {
            
            document.body.addEventListener('dragover', onDragOver);
            document.body.addEventListener('drop', onDrop);


        }

        async function run() {

            await cornerstone3dCore.init();

            setup();


        };

        function setup() {

            const renderingEngineId = 'r';
            renderingEngine = new cornerstone3dCore.RenderingEngine(renderingEngineId);

            const viewportId = 'viewer';

            element = document.getElementById('viewer');

            viewportInput = {
                viewportId,
                element,
                type: cornerstone3dCore.Enums.ViewportType.STACK,
            };

            renderingEngine.enableElement(viewportInput);


        };

        function onDragOver(e) {

            // stop browser processing right away
            e.stopPropagation();
            e.preventDefault();

        };

        function onDrop(e) {

            e.stopPropagation();
            e.preventDefault();

            files = e.dataTransfer.files;

            imageIds = [];
            for(f in files) {
                imageIds.push(cornerstoneWADOImageLoader.wadouri.fileManager.add(files[f]));
            }

            // file = files[0];
            // imageId = cornerstoneWADOImageLoader.wadouri.fileManager.add(file);

            load_volume();

        }

        async function load_volume() {

            var viewport = renderingEngine.getViewport('viewer');

            viewport.setStack(imageIds).then(() => {
                viewport.render();
            });


            var stack = { currentImageIdIndex: 0, imageIds: imageIds };
            cornerstoneTools.addStackStateManager(viewportInput.element, ["stack"]);
            cornerstoneTools.addToolState(viewportInput, "stack", stack);

        }

        run();
        
    </script>
</head>
<body style='margin:0px;padding:0px;background:black'>
    <div id="viewer" style="width: 100%; height:100%"></div>
</body>
</html>
